name: Reddit Wayback Archiver

on:
  schedule:
    # REDUCED FREQUENCY: Run every 30 minutes instead of every 5
    # This helps avoid rate limiting
    - cron: "*/30 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: archiver
  cancel-in-progress: false

jobs:
  run_archiver:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced from 15 since we process fewer posts
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "requirements.txt not found, installing manually..."
            pip install requests feedparser
          fi
      
      - name: Run Archiver Script
        id: archiver
        env:
          SUBREDDIT: ${{ vars.SUBREDDIT }}
        run: python -u archiver.py
        continue-on-error: true
      
      - name: Generate Run Summary
        if: always()
        run: |
          echo "## üì¶ Archive Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Subreddit:** r/${{ vars.SUBREDDIT }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f seen.txt ]; then
            TOTAL=$(wc -l < seen.txt)
            RECENT=$(tail -n 5 seen.txt | wc -l)
            echo "**Total Archived:** $TOTAL posts" >> $GITHUB_STEP_SUMMARY
            echo "**This Run:** $RECENT posts processed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f failed.txt ]; then
            FAILED_COUNT=$(wc -l < failed.txt)
            RECENT_FAILED=$(tail -n 10 failed.txt | grep -c "523" || echo "0")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**‚ö†Ô∏è Total Failed Attempts:** $FAILED_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "**Recent 523 Errors:** $RECENT_FAILED (Wayback unreachable)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check script outcome
          if [ "${{ steps.archiver.outcome }}" == "success" ]; then
            echo "‚úÖ **Status:** Script completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "üî¥ **Status:** Script encountered errors (check logs)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Add troubleshooting hints
          if [ -f failed.txt ]; then
            RECENT_523=$(tail -n 20 failed.txt | grep -c "523" || echo "0")
            if [ "$RECENT_523" -gt "10" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### üîß Troubleshooting" >> $GITHUB_STEP_SUMMARY
              echo "High number of 523 errors detected. This means:" >> $GITHUB_STEP_SUMMARY
              echo "- Wayback Machine cannot reach Reddit" >> $GITHUB_STEP_SUMMARY
              echo "- Reddit may be blocking Wayback's crawlers" >> $GITHUB_STEP_SUMMARY
              echo "- Try again later or reduce frequency further" >> $GITHUB_STEP_SUMMARY
            fi
          fi
      
      - name: Commit and Push Changes
        run: |
          git config user.name "Wayback Bot"
          git config user.email "bot@users.noreply.github.com"
          
          # Stage files
          git add seen.txt failed.txt 2>/dev/null || true
          
          # Check for changes
          if git diff --quiet --staged; then
            echo "No changes to commit."
            exit 0
          fi

          # Commit locally
          git commit -m "üì¶ Archive update [$(date -u +'%Y-%m-%d %H:%M UTC')]"
          
          # Pull and rebase
          echo "Pulling latest changes..."
          if ! git pull --rebase -Xtheirs origin main; then
            echo "‚ö†Ô∏è Rebase failed. Attempting standard merge..."
            git rebase --abort
            git pull -Xtheirs origin main
          fi
          
          # Push
          git push
      
      - name: Check for critical failures
        if: steps.archiver.outcome == 'failure'
        run: |
          echo "::warning::Archiver script had issues. Check logs for details."
          # Don't fail the job - let it continue to commit partial progress
